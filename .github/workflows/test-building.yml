name: build-testing-packages

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        required: true
        type: choice
        options:
          - 'no'
          - 'yes'
        default: 'no'
      tag_name:
        description: 'Release tag name (if yes above)'
        required: false
        type: string
        default: ''

jobs:
  build:
    name: ${{ matrix.arch }}-${{ matrix.branch }} build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - aarch64_generic
          - x86_64
        branch:
          - openwrt-24.10
          - openwrt-23.05

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: build
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.branch }}
          FEEDNAME: momo
          PACKAGES: luci-app-momo
          NO_REFRESH_CHECK: true

      - name: Prepare release files
        if: github.event.inputs.create_release == 'yes' && github.event.inputs.tag_name != ''
        run: |
          echo "Preparing release files for tag: ${{ github.event.inputs.tag_name }}"
          
          # Buat tar.gz dari package yang dibuild
          if [ -d "bin/packages/${{ matrix.arch }}/momo" ]; then
            echo "Creating momo_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz"
            tar -czf momo_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz -C bin/packages/${{ matrix.arch }}/momo .
            
            # List isi tar untuk debug
            echo "Contents of tar file:"
            tar -tzf momo_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz | head -20
            
            # Buat file info metadata
            echo "Package: luci-app-momo" > release_info_${{ matrix.arch }}-${{ matrix.branch }}.txt
            echo "Architecture: ${{ matrix.arch }}" >> release_info_${{ matrix.arch }}-${{ matrix.branch }}.txt
            echo "OpenWrt Branch: ${{ matrix.branch }}" >> release_info_${{ matrix.arch }}-${{ matrix.branch }}.txt
            echo "Build Date: $(date)" >> release_info_${{ matrix.arch }}-${{ matrix.branch }}.txt
            echo "Commit: ${{ github.sha }}" >> release_info_${{ matrix.arch }}-${{ matrix.branch }}.txt
          else
            echo "ERROR: Directory bin/packages/${{ matrix.arch }}/momo not found!"
            echo "Contents of bin/packages:"
            find bin/packages -type f 2>/dev/null || echo "No files found"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: momo_${{ matrix.arch }}-${{ matrix.branch }}
          path: bin/packages/${{ matrix.arch }}/momo

  release:
    if: github.event.inputs.create_release == 'yes' && github.event.inputs.tag_name != ''
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Permission untuk create release
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: List downloaded files
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -name "*.ipk" | head -20
          
      - name: Prepare release assets
        run: |
          # Kumpulkan semua tar.gz dari matrix build
          mkdir -p release_assets
          
          # Cari semua tar.gz yang dibuat oleh job build
          echo "Looking for release tar.gz files..."
          find . -name "momo_*.tar.gz" -exec cp {} release_assets/ \;
          find . -name "release_info_*.txt" -exec cp {} release_assets/ \;
          
          echo "Release assets to be uploaded:"
          ls -la release_assets/
          
          # Buat summary file
          echo "# Release ${{ github.event.inputs.tag_name }}" > release_assets/RELEASE_NOTES.md
          echo "Built on: $(date)" >> release_assets/RELEASE_NOTES.md
          echo "Commit: ${{ github.sha }}" >> release_assets/RELEASE_NOTES.md
          echo "" >> release_assets/RELEASE_NOTES.md
          echo "## Architectures:" >> release_assets/RELEASE_NOTES.md
          echo "- aarch64_generic" >> release_assets/RELEASE_NOTES.md
          echo "- x86_64" >> release_assets/RELEASE_NOTES.md
          echo "" >> release_assets/RELEASE_NOTES.md
          echo "## OpenWrt Branches:" >> release_assets/RELEASE_NOTES.md
          echo "- openwrt-23.05" >> release_assets/RELEASE_NOTES.md
          echo "- openwrt-24.10" >> release_assets/RELEASE_NOTES.md
          
      - name: Debug - Check GITHUB_TOKEN permissions
        run: |
          echo "GITHUB_TOKEN will be used for release"
          echo "Event inputs:"
          echo "  create_release: ${{ github.event.inputs.create_release }}"
          echo "  tag_name: ${{ github.event.inputs.tag_name }}"
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            release_assets/momo_*.tar.gz
            release_assets/release_info_*.txt
            release_assets/RELEASE_NOTES.md
          tag_name: ${{ github.event.inputs.tag_name }}
          name: Release ${{ github.event.inputs.tag_name }}
          body: |
            OpenWrt packages for luci-app-momo
            
            **Build Details:**
            - Commit: ${{ github.sha }}
            - Date: ${{ github.event.created_at }}
            
            **Supported Architectures:**
            - aarch64_generic
            - x86_64
            
            **OpenWrt Versions:**
            - openwrt-23.05
            - openwrt-24.10
            
            Download the appropriate package for your architecture and OpenWrt version.
          draft: false
          prerelease: false
          generate_release_notes: true
