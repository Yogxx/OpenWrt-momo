name: build-testing-packages

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        required: true
        type: choice
        options:
          - 'no'
          - 'yes'
        default: 'no'
      tag_name:
        description: 'Release tag name (if yes above)'
        required: false
        type: string
        default: ''

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # IMPORTANT: Ini harus ada!
    
    strategy:
      matrix:
        arch: [aarch64_generic, x86_64]
        branch: [openwrt-24.10, openwrt-23.05]
    
    steps:
      - name: Debug - Check inputs
        run: |
          echo "Inputs received:"
          echo "create_release: ${{ github.event.inputs.create_release }}"
          echo "tag_name: ${{ github.event.inputs.tag_name }}"
          echo "Should create release: ${{ github.event.inputs.create_release == 'yes' && github.event.inputs.tag_name != '' }}"

      - name: checkout
        uses: actions/checkout@v4

      - name: build
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.branch }}
          FEEDNAME: momo
          PACKAGES: luci-app-momo
          NO_REFRESH_CHECK: true

      - name: Create release package
        id: create_pkg
        run: |
          echo "Checking if package directory exists..."
          if [ -d "bin/packages/${{ matrix.arch }}/momo" ]; then
            echo "âœ“ Package directory exists"
            # Hitung jumlah file .ipk
            IPK_COUNT=$(find bin/packages/${{ matrix.arch }}/momo -name "*.ipk" | wc -l)
            echo "Found $IPK_COUNT .ipk files"
            
            # Buat tar.gz
            tar -czf momo_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz -C bin/packages/${{ matrix.arch }}/momo .
            echo "Created: momo_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz"
            
            # Simpan nama file untuk step berikutnya
            echo "PKG_FILE=momo_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz" >> $GITHUB_OUTPUT
          else
            echo "âœ— ERROR: Directory bin/packages/${{ matrix.arch }}/momo not found!"
            ls -la bin/packages/ || echo "bin/packages/ tidak ada"
            exit 1
          fi

      - name: Upload as artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.arch }}-${{ matrix.branch }}
          path: |
            momo_${{ matrix.arch }}-${{ matrix.branch }}.tar.gz
            bin/packages/${{ matrix.arch }}/momo/

  create-release:
    if: github.event.inputs.create_release == 'yes' && github.event.inputs.tag_name != ''
    needs: build-and-release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # CRITICAL: Permission untuk create release
    
    steps:
      - name: Debug before release
        run: |
          echo "=== DEBUG INFO ==="
          echo "Tag name: ${{ github.event.inputs.tag_name }}"
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Should create release: YES"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          
      - name: List downloaded files
        run: |
          echo "=== Downloaded files ==="
          find release-assets -type f -name "*.tar.gz" | while read file; do
            echo "ðŸ“¦ $(basename "$file") - $(du -h "$file" | cut -f1)"
          done
          
          # Pindahkan semua tar.gz ke root
          find release-assets -name "*.tar.gz" -exec cp {} . \;
          
          echo "=== Files ready for release ==="
          ls -la *.tar.gz || echo "No tar.gz files found"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.tar.gz
          tag_name: ${{ github.event.inputs.tag_name }}
          name: Release ${{ github.event.inputs.tag_name }}
          body: |
            OpenWrt packages for luci-app-momo
            
            **Version:** ${{ github.event.inputs.tag_name }}
            **Build Date:** $(date)
            
            **Packages included:**
            - luci-app-momo
            
            **Architectures:**
            - aarch64_generic (ARM64)
            - x86_64
            
            **OpenWrt Versions:**
            - 23.05
            - 24.10
            
            Extract the tar.gz file and copy the .ipk files to your OpenWrt device.
          draft: false
          prerelease: false
          generate_release_notes: true
